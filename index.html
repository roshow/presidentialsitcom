<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>A Presidential Sitcom</title>
        <meta name="description" content="A rich old white guy says so much crazy, angry shit that he becomes President. But now he's got to figure out how to run a whole country!">
        
        <!-- Twitter Card data -->
        <meta name="twitter:card" value="summary">

        <!-- Open Graph data -->
        <meta property="og:title" content="A Presidential Sitcom" />
        <meta property="og:type" content="article" />
        <!-- <meta property="og:url" content="http://presidentialsit.com/" /> -->
        <!-- <meta property="og:image" content="http://example.com/image.jpg" /> -->
        <meta property="og:description" content="A rich old white guy says so much crazy, angry shit that he becomes President. But now he's got to figure out how to run a whole country!" />

        <link rel="shortcut icon" href="/favicon.ico">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
        <link href="https://fonts.googleapis.com/css?family=PT+Mono|Source+Code+Pro|Ubuntu+Mono" rel="stylesheet">

        <style type="text/css">        

          html {
            box-sizing: border-box;
          }
          *, *:before, *:after {
            box-sizing: inherit;
          }

          body {
            background: #D3D3D3;
            font-family: 'PT Mono', monospace;
          }

          header { cursor: pointer; }

          h3 {
            text-align: center;
            margin: 40px 0 0;
            cursor: pointer;
          }

          section {
            width: 100%;
            max-width: 600px;
            margin: auto;
          }

          .clearfix { clear:both; }

          .displayNone { display: none; }

          .entry {
            background: #ffffff;
            padding: 25px 40px;
            margin: 40px 0;
          }
          
          p {
            font-size: 14px;
            line-height: 1.5em;
          }

          a {
            color: #696969;
            font-size: 11px;
          }

          a:hover { color: #000000; }

          .tags { font-size: 10px; }

          .tag {
            text-decoration: underline;
            cursor: pointer;
          }

          .btn {
            font-size: 14px;
            display: inline-block;
            cursor: pointer;
            font-weight: 900;
            width: 130px;
            padding: 10px;
            color: #696969;
          }

          .btn:hover { color: #000000; }

          .btn.hide{ display: none }

          .btn.btn-previous { float: left; }

          .btn.btn-next {
            float: right;
            text-align: right;
          }

          .permalink {
            text-align: right;
            margin: 0;
          }

          .episode .permalink { display: none; }

          .episode .entry { margin-bottom: 10px; }

          .showSummary {
            /*text-align: center;*/
            padding: 0 40px;
            font-family: Helvetica;
          }

        </style>
    </head>
    <body>

        <section id="app"></section>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.1/fetch.js"></script>
        <script type="text/javascript">

          const apiurl = `https://cdn.contentful.com/spaces/vc1pqz55uikb/entries`;
          
          const defaultQuery = {
            'content_type': 'episodes',
            'limit': 100,
            'order': '-sys.createdAt',
            'access_token': '1676b21629539cf0be8b7d7df2a3cb0fd9343767ffd512ea74065aaca9755bc7'
          }
          
          const queryParams = (params={}) => {
            const allParams = Object.assign({}, defaultQuery, params);
            return Object.keys(allParams)
                .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(allParams[k]))
                .join('&');
          }

          const fetchQuery = (params, id='') => fetch(`${ apiurl }/${ id }?${ queryParams(params) }`)
            .then(response => response.json());

          /* Templates or whatever we're calling them these days */

          const headerComponent = (data={}) => `<h3 data-type="path" data-path="/">A Presidential Sitcom</h3>
            ${ 
                data.showSummary ? `<section class="showSummary" >
                  <p>A crazy, rich, old white guy says so much angry stuff that he becomes President. But now he's got to figure out how to run a whole country!</p>
                </section>` : ''
              }
          </div>`;

          const renderWithHeader = (component='', data) => headerComponent(data) + component;

          const entryComponent = data => `<div class="entry">
            <p>${ data.fields.summary }</p>
            <p class="permalink"><a href data-type="episode" data-episode="${ data.sys.id }">${ new Date(data.sys.createdAt).toLocaleString() }</a></p>
          </div>`;

          const episodeListComponent = data => `<div class="episodeList">
            ${ data.items.reduce((htmlStr, item) => htmlStr + entryComponent(item), '') }
          </div>`;

          const episodeComponent = data => `<div class="episode">
            <article>
              ${ entryComponent(data) }
            </article>
            <div data-type="episode" class="btn btn-previous hide">« Previous</div>
            <div data-type="episode" class="btn btn-next hide">Next »</div>
            <div class="clearfix"></div>
          </div>`;

          const updateEpisodeComponent = (data, el) => el.innerHTML = entryComponent(data);

          const setEpisodeArrows = (selector, episode) => {
            const el = document.querySelector(selector);
            if (episode){
              el.classList.remove('hide');
              el.dataset.episode = episode.sys.id;
            }
            else {
              el.classList.add('hide');
            }
          }


          const appEl = document.querySelector('#app');
          
          const render = data => {

            switch (data.sys.type) {
              
              case 'Entry':
                
                const el = document.querySelector('.episode article');
                if (el) {
                  el.innerHTML = updateEpisodeComponent(data, el);
                }
                else {
                  appEl.innerHTML = renderWithHeader(episodeComponent(data));  
                }
                
                /* FETCH PREVIOUS EPISODE */
                fetchQuery({ limit: 1,  [`sys.createdAt[lt]`]: data.sys.createdAt}).then(response => setEpisodeArrows('.btn-previous', response.items[0]));
                
                /* FETCH NEW EPISODE */
                fetchQuery({ limit: 1, [`sys.createdAt[gt]`]: data.sys.createdAt, order: 'sys.createdAt' }).then(response => setEpisodeArrows('.btn-next', response.items[0]));

                return;

              case 'Array':
                
                return appEl.innerHTML = renderWithHeader(episodeListComponent(data));

              case 'Error':
              default:
                
                console.warn('response error', data);
                return appEl.innerHTML = headerComponent() + `<h2>500 Error</h2>`;
            }
          };

          const pathRegex = /^\/episodes\/(.+?(?=\/|$))/

          const renderFromPath = (path, query) => fetchQuery(query, ( path.match(pathRegex) || [] )[1] ).then( data => {
            return render(data);
          });

          const renderFromCurrentPath = query => renderFromPath(window.location.pathname);

          const changePath = (path, renderMethod, state=null) => {
            history.pushState(state, null, path);
            return renderMethod(path);
          }

          const changePathAndRender = (path, state) => changePath(path, renderFromPath, state);

          appEl.addEventListener('click', e => {
            
            const dataset = e.target.dataset;
            if (dataset.type) {
              e.preventDefault();
              e.stopPropagation();
              switch (dataset.type) {
                case 'path':
                  return changePathAndRender(dataset.path);
                case 'episode':
                  return changePathAndRender(`/episodes/${ dataset.episode }`);
                default:
                  return;
              }
            }
          });
          window.addEventListener('popstate', e => renderFromCurrentPath()); 

          renderFromCurrentPath();

        </script>
    </body>
</html>